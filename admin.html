<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  body { font-family: sans-serif; margin: 20px; }
  table { width: 100%; border-collapse: collapse; margin-top: 20px; }
  th, td { padding: 10px; border: 1px solid #ddd; text-align: center; }
  th { background: #f2f2f2; }
  .btn { padding: 6px 10px; cursor: pointer; border: none; border-radius: 4px; }
  .update { background: #4caf50; color: #fff; }
  .delete { background: #d9534f; color: #fff; }
</style>

</head>
<body>

<h2>ğŸ“¦ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h2>

<table>
  <thead>
    <tr>
      <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
      <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
      <th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
      <th>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</th>
      <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
      <th>ØªØ­Ø¯ÙŠØ«</th>
      <th>Ø­Ø°Ù</th>
      <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
    </tr>
  </thead>
  <tbody id="orders-table"></tbody>
</table>

<script>
const supabase = supabase.createClient(
  "https://qccpddjnozehorhleegz.supabase.co",
  "YOUR_PUBLIC_ANON_KEY_HERE"
);

// ==== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ====
async function loadOrders() {
  const { data, error } = await supabase
    .from("orders")
    .select(`
      *,
      order_items(
        quantity,
        price,
        products(name)
      )
    `)
    .order("created_at", { ascending: false });

  if (error) {
    console.error(error);
    return;
  }

  const tbody = document.getElementById("orders-table");
  tbody.innerHTML = "";

  data.forEach(order => {
    let productsHtml = "";

    if (Array.isArray(order.order_items)) {
      productsHtml = order.order_items.map(i => `
        <div>
          ${i.products?.name || "Ù…Ù†ØªØ¬"} â€” ${i.price} Ø¬Ù†ÙŠÙ‡ Ã— ${i.quantity}
        </div>
      `).join("");
    }

    tbody.innerHTML += `
      <tr>
        <td>${order.name}</td>
        <td>${order.phone}</td>
        <td>${order.address}</td>
        <td>${productsHtml}</td>

        <td>
          <select onchange="updateStatus(${order.id}, this.value)">
            <option ${order.status === "Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ²" ? "selected" : ""}>Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ²</option>
            <option ${order.status === "ØªÙ… Ø§Ù„Ø´Ø­Ù†" ? "selected" : ""}>ØªÙ… Ø§Ù„Ø´Ø­Ù†</option>
            <option ${order.status === "ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…" ? "selected" : ""}>ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</option>
          </select>
        </td>

        <td><button class="btn update" onclick="forceUpdate(${order.id})">âœ” ØªØ­Ø¯ÙŠØ«</button></td>
        <td><button class="btn delete" onclick="deleteOrder(${order.id})">ğŸ—‘ Ø­Ø°Ù</button></td>

        <td>${new Date(order.created_at).toLocaleString("ar-EG")}</td>
      </tr>
    `;
  });
}

// ==== ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© ====
async function updateStatus(id, status) {
  await supabase.from("orders").update({ status }).eq("id", id);
}

// ==== Ø²Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ« ====
async function forceUpdate(id) {
  alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­ âœ”");
}

// ==== Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ ====
async function deleteOrder(id) {
  if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ØŸ")) return;

  await supabase.from("orders").delete().eq("id", id);
  loadOrders();
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
loadOrders();
</script>

</body>
</html>
