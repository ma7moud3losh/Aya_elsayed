<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª - AYA</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{font-family:'Tajawal',sans-serif;background:#faf7fb;margin:0}
.container{max-width:1100px;margin:30px auto;padding:16px}
h2{margin:0 0 20px}
.table{width:100%;border-collapse:collapse;background:#fff;border-radius:12px;overflow:hidden}
.table th,.table td{padding:14px;border-bottom:1px solid #eee;text-align:right;font-size:15px}
.table th{background:#ff4f9d;color:white}
.empty{text-align:center;padding:40px;color:#777}
.btn-del{
  background:#ff2e63;color:#fff;padding:6px 10px;border:none;border-radius:8px;cursor:pointer;
}
.status-select{
  padding:6px 10px;border:1px solid #ddd;border-radius:8px;
}
</style>
</head>
<body>

<div class="container">
<h2>ğŸ“¦ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h2>

<table class="table">
<thead>
<tr>
<th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
<th>Ø§Ù„Ù‡Ø§ØªÙ</th>
<th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
<th>Ø§Ù„Ù…Ù†ØªØ¬</th>
<th>Ø§Ù„Ø³Ø¹Ø±</th>
<th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
<th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
<th>ØªØ­Ø¯ÙŠØ«</th>
<th>Ø­Ø°Ù</th>
<th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
</tr>
</thead>
<tbody id="orders-body">
<tr><td colspan="8" class="empty">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</td></tr>
</tbody>
</table>
</div>

<script>
// =========================
// Supabase
// =========================
const supabaseUrl = "https://qccpddjnozehorhleegz.supabase.co";
const supabaseKey = "sb_publishable_rSdFTm7TUh-HDRLKacdZxw_BpQOTeIr";
const client = window.supabase.createClient(supabaseUrl, supabaseKey);

// =========================
// Load Orders
// =========================
async function loadOrders(){
  const tbody = document.getElementById("orders-body");

  const { data, error } = await client
    .from("orders")
    .select(`*, products(name)`)
    .order("created_at", { ascending:false });

  if(error){
    tbody.innerHTML = `<tr><td colspan="8" class="empty">âš  Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</td></tr>`;
    return;
  }

  if(!data || data.length === 0){
    tbody.innerHTML = `<tr><td colspan="8" class="empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</td></tr>`;
    return;
  }

  tbody.innerHTML = "";
  data.forEach(o=>{
    tbody.innerHTML += `
  <tr>
    <td>${o.name}</td>
    <td>${o.phone}</td>
    <td>${o.address}</td>

    <td>${o.products?.name || "â€”"}</td>
    <td>${o.products?.price || 0} Ø¬Ù†ÙŠÙ‡</td>
    <td>${o.products?.price || 0} Ø¬Ù†ÙŠÙ‡</td>

    <td>
      <select id="status-${o.id}" class="status-select">
        <option value="Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ²" ${o.status==="Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ²"?"selected":""}>Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ²</option>
        <option value="ØªÙ… Ø§Ù„Ø´Ø­Ù†" ${o.status==="ØªÙ… Ø§Ù„Ø´Ø­Ù†"?"selected":""}>ØªÙ… Ø§Ù„Ø´Ø­Ù†</option>
        <option value="Ù…ÙƒØªÙ…Ù„" ${o.status==="Ù…ÙƒØªÙ…Ù„"?"selected":""}>Ù…ÙƒØªÙ…Ù„</option>
        <option value="Ù…Ù„ØºÙŠ" ${o.status==="Ù…Ù„ØºÙŠ"?"selected":""}>Ù…Ù„ØºÙŠ</option>
      </select>
    </td>

    <td>
      <button onclick="updateStatus('${o.id}')" class="btn-del" style="background:#4caf50">âœ” ØªØ­Ø¯ÙŠØ«</button>
    </td>

    <td>
      <button onclick="deleteOrder('${o.id}')" class="btn-del">ğŸ—‘ Ø­Ø°Ù</button>
    </td>

    <td>${new Date(o.created_at).toLocaleString('ar-EG')}</td>
  </tr>
`;
  });
}

// =========================
// Update Status
// =========================
async function updateStatus(id, newStatus) {
  const { data, error } = await supabase
    .from("orders")
    .update({ status: newStatus })
    .eq("id", id);

  if (error) {
    console.error(error);
    alert("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«");
    return;
  }

  alert("âœ” ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­");
  loadOrders(); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«
}     
// =========================
// Delete Order
// =========================
async function deleteOrder(id){
  if(!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ØŸ")) return;

  const { error } = await client
    .from("orders")
    .delete()
    .eq("id", id);

  if(error){
    alert("âŒ ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù");
  } else {
    alert("ğŸ—‘ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨");
    loadOrders();
  }
}

loadOrders();
</script>

</body>
</html>
