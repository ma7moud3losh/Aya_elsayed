<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  body { font-family: "Tajawal", sans-serif; margin: 20px; background:#fafafa }
  table { width: 100%; border-collapse: collapse; margin-top: 20px; background:white }
  th, td { padding: 10px; border: 1px solid #ddd; text-align: center; }
  th { background: #f2f2f2; }
  select { padding:5px; }
  .btn { padding: 6px 10px; cursor: pointer; border: none; border-radius: 4px; }
  .update { background: #4caf50; color: #fff; }
  .delete { background: #d9534f; color: #fff; }
  h2{margin:0;padding:10px;background:white;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.06);display:inline-block}
</style>

</head>
<body>

<h2>ğŸ“¦ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h2>

<table>
  <thead>
    <tr>
      <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
      <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
      <th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
      <th>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</th>
      <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
      <th>ØªØ­Ø¯ÙŠØ«</th>
      <th>Ø­Ø°Ù</th>
      <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
    </tr>
  </thead>
  <tbody id="orders-table"></tbody>
</table>

<script>
// ========= Ø±Ø¨Ø· Supabase =========
const supabaseClient = supabase.createClient(
  "https://qccpddjnozehorhleegz.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjY3BkZGpub3plaG9yaGxlZWd6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2MTc0NzEsImV4cCI6MjA3OTE5MzQ3MX0.WzG0u9c6wY9eTTh0olIzrPSSPoHhuQhmLTS7zPxXBGA"
);

// ========= ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª =========
async function loadOrders() {
  const { data, error } = await supabaseClient
    .from("orders")
    .select(`
      *,
      order_items(
        quantity,
        price,
        products(
          name
        )
      )
    `)
    .order("created_at", { ascending: false });

  if (error) {
    console.error("Ø®Ø·Ø£:", error);
    return;
  }

  const tbody = document.getElementById("orders-table");
  tbody.innerHTML = "";

  data.forEach(order => {
    let productsHtml = "";

    if (Array.isArray(order.order_items)) {
      productsHtml = order.order_items
        .map(item => `
          <div>
            ${item.products?.name || "Ù…Ù†ØªØ¬"} â€” ${item.price} Ø¬Ù†ÙŠÙ‡ Ã— ${item.quantity}
          </div>
        `)
        .join("");
    }

    tbody.innerHTML += `
      <tr>
        <td>${order.name}</td>
        <td>${order.phone}</td>
        <td>${order.address}</td>

        <td>${productsHtml}</td>

        <td>
          <select onchange="updateStatus(${order.id}, this.value)">
            <option value="Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ²" ${order.status === "Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ²" ? "selected" : ""}>Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ²</option>
            <option value="ØªÙ… Ø§Ù„Ø´Ø­Ù†" ${order.status === "ØªÙ… Ø§Ù„Ø´Ø­Ù†" ? "selected" : ""}>ØªÙ… Ø§Ù„Ø´Ø­Ù†</option>
            <option value="ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…" ${order.status === "ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…" ? "selected" : ""}>ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</option>
          </select>
        </td>

        <td><button class="btn update" onclick="forceUpdate()">âœ” Ø­ÙØ¸</button></td>
        <td><button class="btn delete" onclick="deleteOrder(${order.id})">ğŸ—‘ Ø­Ø°Ù</button></td>

        <td>${new Date(order.created_at).toLocaleString("ar-EG")}</td>
      </tr>
    `;
  });
}

// ========= ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ =========
async function updateStatus(id, status) {
  await supabaseClient.from("orders").update({ status }).eq("id", id);
}

// ========= Ø²Ø± Ø­ÙØ¸ Ø§Ù„ØªØ­Ø¯ÙŠØ« =========
function forceUpdate() {
  alert("âœ” ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ù†Ø¬Ø§Ø­");
}

// ========= Ø­Ø°Ù Ø·Ù„Ø¨ =========
async function deleteOrder(id) {
  if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ØŸ")) return;

  await supabaseClient.from("orders").delete().eq("id", id);
  loadOrders();
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
loadOrders();

</script>

</body>
</html>
