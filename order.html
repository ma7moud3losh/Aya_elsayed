<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>إتمام الطلب — AYA Beauty</title>

<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{font-family:'Tajawal',sans-serif;background:#faf7fb;margin:0;padding:20px;color:#333}
.container{max-width:600px;margin:auto;background:white;padding:20px;border-radius:16px;box-shadow:0 5px 20px rgba(0,0,0,0.08)}
h2{text-align:center;margin-bottom:20px}
input,textarea{
  width:100%;padding:10px;margin:8px 0;border:1px solid #ddd;border-radius:8px;font-size:15px;
}
.btn{
  width:100%;padding:12px;border:none;border-radius:10px;background:#ff4f9d;color:white;
  font-size:17px;font-weight:bold;margin-top:10px;cursor:pointer;
}
.cart-item{background:#f5f5f5;padding:10px;border-radius:10px;margin-bottom:10px}
</style>
</head>

<body>

<div class="container">

  <h2>إتمام الطلب</h2>

  <div id="cartItems"></div>

  <hr>

  <h3>بيانات التوصيل</h3>

  <input id="name" type="text" placeholder="الاسم بالكامل">
  <input id="phone" type="text" placeholder="رقم الهاتف">
  <textarea id="address" placeholder="العنوان بالتفصيل"></textarea>

  <button class="btn" onclick="sendOrder()">إرسال الطلب</button>

</div>

<script>
// ===============================
// Supabase Connection
// ===============================
const supabase = window.supabase.createClient(
  "https://qccpddjnozehorhleegz.supabase.co",
  "sb-publishable_rSdFTm7TUh-HDRLKacdZxw_BpQOTeIr" // ضعي المفتاح الجديد لو تغير
);

// ===============================
// تحميل السلة في صفحة إتمام الطلب
// ===============================
function loadCartForOrder() {
  let cart = JSON.parse(localStorage.getItem("cart")) || [];
  let box = document.getElementById("cartItems");

  if (cart.length === 0) {
    box.innerHTML = "<p style='color:#777;text-align:center'>السلة فارغة</p>";
    return;
  }

  box.innerHTML = "<h3>المنتجات</h3>";

  cart.forEach(item => {
    box.innerHTML += `
      <div class="cart-item">
        <strong>${item.name}</strong><br>
        السعر: ${item.price} جنيه<br>
        الكمية: ${item.qty}
      </div>
    `;
  });
}

loadCartForOrder();

// ===============================
// إرسال الطلب
// ===============================
async function sendOrder() {
  const name = document.getElementById("name").value.trim();
  const phone = document.getElementById("phone").value.trim();
  const address = document.getElementById("address").value.trim();

  if (!name || !phone || !address) {
    alert("من فضلك أكمل جميع البيانات");
    return;
  }

  let cart = JSON.parse(localStorage.getItem("cart")) || [];
  if (cart.length === 0) {
    alert("السلة فارغة!");
    return;
  }

  // حساب الإجمالي
  const totalPrice = cart.reduce((t, x) => t + (x.price * x.qty), 0);

  // 1) إنشاء الطلب الرئيسي (orders)
  const { data: order, error: orderError } = await supabase
    .from("orders")
    .insert({
      name,
      phone,
      address,
      total_price: totalPrice,
      status: "قيد التجهيز"
    })
    .select()
    .single();

  if (orderError) {
    console.error(orderError);
    alert("حدث خطأ أثناء إنشاء الطلب!");
    return;
  }

  const orderId = order.id;

  // 2) إنشاء صفوف order_items
  const itemsRows = cart.map(item => ({
    order_id: orderId,
    product_id: item.id,   // مهم: UUID
    quantity: item.qty,
    price: item.price
  }));

  const { error: itemsError } = await supabase
    .from("order_items")
    .insert(itemsRows);

  if (itemsError) {
    console.error(itemsError);
    alert("حدث خطأ أثناء حفظ المنتجات!");
    return;
  }

  // 3) إنهاء العملية
  localStorage.removeItem("cart");
  alert("تم إرسال طلبك بنجاح ❤️");
  location.href = "index.html";
}

</script>

</body>
</html>
